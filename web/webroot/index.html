<html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/highcharts-more.js"></script>
<style>
body {
    font-family: "Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, sans-serif;
}
div.current > div+div {
    margin-left: 2em;
}
div.current span {
    text-align: right;
}
</style>
<div class="current">
    <div style="padding: 3px; float: left;">
        <div>
            Temperature: <span style="float: right; margin-left: 1.5em;"><span id="current_temp"></span>&deg;C</span>
        </div>
        <div>
            Humidity: <span style="float: right; margin-left: 1.5em;"><span id="current_humidity"></span>%</span>
        </div>
        <div>
            Pressure: <span style="float: right; margin-left: 1.5em;"><span id="current_pressure"></span>hPa</span>
        </div>
        <div>
            Tendency: <span style="float: right; margin-left: 1.5em;"><span id="pressure_tendency"></span></span>
        </div>
    </div>
    <div style="padding: 3px; float: left;">
        <div>
            Wind: <span style="float: right;margin-left: 1.5em;"><span id="current_wind"></span>m/s</span>
        </div>
        <div>
            Wind Direction: <span style="float: right;margin-left: 1.5em;"><span id="current_wind_dir"></span></span>
        </div>
        <div id="current_wind_angle" style="margin-left: auto; margin-right: auto; font-size:150%; text-align: center; width: 1.5em; height: 1.5em; float: right;">&#x27A4;</div>
    </div>
    <br style="clear: both; height: 0" />
</div>

<div id="temp" style="width:32%; height:250px;display:inline-block"></div>
<div id="humidity" style="width:32%; height:250px;display:inline-block"></div>
<div id="pressure" style="width:32%; height:250px;display:inline-block"></div>
<div id="wind" style="width:49%; height:250px;display:inline-block"></div>
<div id="winddir" style="width:49%; min-width:400px; height:250px;display:inline-block"></div>
<div id="rain" style="width:49%; height:250px;"></div>
<script>
function getQueryVariable(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
        if(pair[0] == variable){return pair[1];}
    }
    return(false);
}

function populateCurrentData() {
    $.getJSON("/currentdata.json", function(data) {
        $('#current_temp').html(data['Temperature'].toFixed(1));
        $('#current_humidity').html(data['Humidity'].toFixed(0));
        $('#current_pressure').html(data['Pressure'].toFixed(1));
        $('#current_wind').html(data['Wind'].toFixed(1));
        $('#current_wind_dir').html(degreesToCardinal(data['WindDir']));
        $('#current_wind_angle').css("transform", "rotate(" + (data['WindDir'] - 90) + "deg)");
    });
    $.getJSON("/change.json?type=Pressure", function(data) {
        if (data.Change[0] >= 0.1) {
            result = "Rising";
        } else if (data.Change[0] <= -0.1) {
            result = "Falling";
        } else {
            result = "Steady";
        }

        abs = Math.abs(data.Change[0]);
        if (abs >= 6) {
            result += "<br />(Very Rapidly)";
        } else if (abs >= 3.6) {
            result += "<br />(Quickly)";
        } else if (abs >= 1.6) {
        } else {
            result += "<br />(Slowly)";
        }
        $('#pressure_tendency').html(result);
    });
    setTimeout(populateCurrentData, 30000);
}

function degreesToCardinal(angle) {
    switch (angle) {
        case 0:
            return "N";
        case 22.5:
            return "NNE";
        case 45:
            return "NE";
        case 67.5:
            return "ENE";
        case 90:
            return "E";
        case 112.5:
            return "ESE";
        case 135:
            return "SE";
        case 157.5:
            return "SSE";
        case 180:
            return "S";
        case 202.5:
            return "SSW";
        case 225:
            return "SW";
        case 247.5:
            return "WSW";
        case 270:
            return "W";
        case 292.5:
            return "WNW";
        case 315:
            return "NW";
        case 337.5:
            return "NNW";
        case 360:
            return "N";
        default:
            return angle;
    }
}

function makeChart(query, container, name, units, showRange) {
    showRange = typeof showRange !== 'undefined' ? showRange : true;
    var title;
    var enablelegend;
    if (name instanceof Array) {
        title = name[0];
        enablelegend = true;
    } else {
        title = name;
        enablelegend = false;
    }
    var options = {
        chart: {
            renderTo: container,
            zoomType: 'x',
        },
        title: {
            text: title,
        },
        xAxis: {
			type: 'datetime'
        },
        yAxis: {
            title: {
                text: title + " (" + units + ")",
            },
            minPadding: 0,
        },
        tooltip: {
            valueDecimals: 1,
            valueSuffix: " " + units,
        },
        legend: {
            enabled: enablelegend,
        },
    };
    $.getJSON(query, function(data) {
        options.series = [];
        for (var i = 0; i < data.Data.length; i++) {
            if (name instanceof Array) {
                title = name[i+1];
            } else {
                title = name;
            }
            options.series.push({
                type: 'spline',
                data: data.Data[i],
                name: title,
                marker: {enabled: false,},
            });
            if (showRange) {
                options.series.push({
                    type: 'areasplinerange',
                    data: data.Errorbars[i],
                    enableMouseTracking: false,
                    color: Highcharts.getOptions().colors[i],
                    fillOpacity: 0.3,
                    zIndex: 0,
                    linkedTo: ":previous",
                    visible: showRange,
                });
            }
        }
        var chart = new Highcharts.Chart(options);
        setInterval(function() {
            $.getJSON(query, function(data) {
                for (var i = 0; i < data.Data.length; i++) {
                    if (showRange) {
                        chart.series[i * 2].setData(data.Data[i]);
                        chart.series[i * 2 + 1].setData(data.Errorbars[i]);
                    } else {
                        chart.series[i].setData(data.Data[i]);
                    }
                }
            });
        },300000);
    });
}
var timeframe;
$(document).ready(function() {
    timeframe = getQueryVariable("time");
    if (!timeframe) {
        timeframe = "24h";
    }
    var showRange = true;
    if (timeframe == "24h" || timeframe == "1d" || timeframe == "3h") {
        showRange = false;
    }
    Highcharts.setOptions({
        title: {
            style: {
                fontSize: '12px',
            }
        },
        credits: {
            enabled: false,
        },
    });
    makeChart("/data.json?type=Pressure&time=" + timeframe, pressure, "Pressure", "hPa", showRange);
    makeChart("/data.json?type=Temperature&id=OS3:F824,DHT,BMP&time=" + timeframe, temp, ["Temperature", "Outside", "Inside (DHT)", "Inside (BMP)"], "\u00B0C", showRange);
    makeChart("/data.json?type=Humidity&id=OS3:F824,DHT&time=" + timeframe, humidity, ["Humidity", "Outside", "Inside"], "%", showRange);
    makeChart("/data.json?type=AverageWind[avg],CurrentWind[max]&time=" + timeframe, 'wind', ["Wind Speed", "Average Wind", "Gusts"], "m/s", false, showRange);

    var options = {
        chart: {
            zoomType: 'x',
        },
        xAxis: {
			type: 'datetime'
        },
        tooltip: {
            valueDecimals: 1,
        },
        legend: {
            enabled: false,
        },
    };

    $.getJSON("/data.json?type=RainRate,RainTotal&time=" + timeframe, function(data) {
        initialrain = data.Data[1][0][1];
        for (i = 0; i < data.Data[1].length; i++) {
            data.Data[1][i][1] -= initialrain;
        }
        options.chart.renderTo = 'rain';
        options.title = {
            text: "Rainfall",
        };
        options.yAxis = [{title: {text: 'Rainfall Rate (mm/h)'}},{title: {text: 'Total Rain (mm)'}, opposite: true,minRange: 1,min: 0,}];
        options.series = [
        {
            type: 'spline',
            data: data.Data[0],
            name: 'Rainfall Rate',
        },
        {
            type: 'spline',
            data: data.Data[1],
            name: 'Total Rain',
            yAxis: 1,
        },
        ];
        options.legend.enabled = true;
        var chart = new Highcharts.Chart(options);

        setInterval(function() {
            $.getJSON("/data.json?type=RainRate,RainTotal&time=" + timeframe, function(data) {
                initialrain = data.Data[1][0][1];
                for (i = 0; i < data.Data[1].length; i++) {
                    data.Data[1][i][1] -= initialrain;
                }
                chart.series[0].setData(data.Data[0]);
                chart.series[1].setData(data.Data[1]);
            });
        },300000);
    });

    $.getJSON("/wind.json?time=" + timeframe, function(data) {
        var options = {
            chart: {
                renderTo: 'winddir',
                polar: true,
                marginRight: 0,
            },
            title: {
                text: 'Wind Direction',
            },
            pane: {
                startAngle:0,
                endAngle: 360,
            },
            xAxis: {
                tickInterval: 45,
                labels: {
                    formatter: function() {
                        return degreesToCardinal(this.value);
                    }
                },
            },
            yAxis: {
               min: 0,
            },
            legend: {
                align: 'right',
                layout: 'vertical',
                verticalAlign: 'bottom',
            },
            tooltip: {
                valueDecimals: 1,
            },
            plotOptions: {
                series: {
                    pointStart: 0,
                    pointInterval: 11.25,
                },
            },
            series: [
                {
                    type: 'area',
                    data: data.Wind,
                    name: 'Average',
                    zIndex: 1,
                },
                {
                    type: 'area',
                    data: data.Gust,
                    fillOpacity: 0.3,
                    zIndex: 0,
                    name: 'Gust',
                },
            ],
            tooltip: {
                valueDecimals: 1,
                valueSuffix: " m/s",
            },
        };
        var chart = new Highcharts.Chart(options);
        setInterval(function() {
            $.getJSON("/wind.json?time=" + timeframe, function(data) {
                chart.series[0].setData(data.Wind);
                chart.series[1].setData(data.Gust);
            });
        },300000);
    });

    populateCurrentData();
});
</script>
</html>
